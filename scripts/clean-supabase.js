const { createClient } = require('@supabase/supabase-js')
require('dotenv').config({ path: '.env.local' })

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY

const supabase = createClient(supabaseUrl, supabaseKey)

async function cleanSupabase() {
  console.log('üßπ –û—á–∏—â–µ–Ω–Ω—è Supabase...')
  
  try {
    // –í–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
    console.log('üóëÔ∏è –í–∏–¥–∞–ª–µ–Ω–Ω—è –≤—Å—ñ—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤...')
    const { error: deleteUsersError } = await supabase
      .from('users')
      .delete()
      .neq('id', '00000000-0000-0000-0000-000000000000') // –í–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ—Ö

    if (deleteUsersError) {
      console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤:', deleteUsersError)
    } else {
      console.log('‚úÖ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –≤–∏–¥–∞–ª–µ–Ω—ñ')
    }

    // –í–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç–∏
    console.log('üóëÔ∏è –í–∏–¥–∞–ª–µ–Ω–Ω—è –≤—Å—ñ—Ö —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç—ñ–≤...')
    const { error: deleteUniError } = await supabase
      .from('universities')
      .delete()
      .neq('id', 0) // –í–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ

    if (deleteUniError) {
      console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç—ñ–≤:', deleteUniError)
    } else {
      console.log('‚úÖ –£–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç–∏ –≤–∏–¥–∞–ª–µ–Ω—ñ')
    }

    console.log('üéâ Supabase –æ—á–∏—â–µ–Ω–æ!')
    
  } catch (error) {
    console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –æ—á–∏—â–µ–Ω–Ω—è:', error)
  }
}

async function recreateTables() {
  console.log('üîß –ü–µ—Ä–µ—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å...')
  
  console.log('üìã SQL –∫–æ–º–∞–Ω–¥–∏ –¥–ª—è –ø–µ—Ä–µ—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å:')
  console.log(`
-- –í–∏–¥–∞–ª–µ–Ω–Ω—è —Å—Ç–∞—Ä–∏—Ö —Ç–∞–±–ª–∏—Ü—å
DROP TABLE IF EXISTS users CASCADE;
DROP TABLE IF EXISTS universities CASCADE;

-- –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–∏—Ö —Ç–∞–±–ª–∏—Ü—å
CREATE TABLE universities (
  id SERIAL PRIMARY KEY,
  name TEXT NOT NULL UNIQUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE users (
  id TEXT PRIMARY KEY,
  telegram_id TEXT UNIQUE,
  telegram_username TEXT,
  university_id INTEGER REFERENCES universities(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –í—Å—Ç–∞–≤–∫–∞ —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç—ñ–≤
INSERT INTO universities (name) VALUES 
('–•–∞—Ä–∫—ñ–≤—Å—å–∫–∏–π –Ω–∞—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç —ñ–º–µ–Ω—ñ –í. –ù. –ö–∞—Ä–∞–∑—ñ–Ω–∞'),
('(–ö–∏–ú–£) –ö–∏—ó–≤—Å—å–∫–∏–π –º—ñ–∂–Ω–∞—Ä–æ–¥–Ω–∏–π —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç'),
('–ß–µ—Ä–∫–∞—Å—å–∫–∞ –º–µ–¥–∏—á–Ω–∞ –∞–∫–∞–¥–µ–º—ñ—è'),
('–í–æ–ª–∏–Ω—Å—å–∫–∏–π –Ω–∞—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç —ñ–º–µ–Ω—ñ –õ–µ—Å—ñ –£–∫—Ä–∞—ó–Ω–∫–∏'),
('–ö–∏—ó–≤—Å—å–∫–∏–π –Ω–∞—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç —ñ–º–µ–Ω—ñ –¢–∞—Ä–∞—Å–∞ –®–µ–≤—á–µ–Ω–∫–∞'),
('–ß–æ—Ä–Ω–æ–º–æ—Ä—Å—å–∫–∏–π –Ω–∞—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç —ñ–º–µ–Ω—ñ –ü–µ—Ç—Ä–∞ –ú–æ–≥–∏–ª–∏'),
('–•–∞—Ä–∫—ñ–≤—Å—å–∫–∏–π –º—ñ–∂–Ω–∞—Ä–æ–¥–Ω–∏–π –º–µ–¥–∏—á–Ω–∏–π —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç'),
('–ú—ñ–∂–Ω–∞—Ä–æ–¥–Ω–∏–π –Ñ–≤—Ä–æ–ø–µ–π—Å—å–∫–∏–π –£–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç'),
('(–ú–ê–£–ü) –ú—ñ–∂—Ä–µ–≥—ñ–æ–Ω–∞–ª—å–Ω–∞ –ê–∫–∞–¥–µ–º—ñ—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º'),
('–î–Ω—ñ–ø—Ä–æ–≤—Å—å–∫–∏–π —ñ–Ω—Å—Ç–∏—Ç—É—Ç –º–µ–¥–∏—Ü–∏–Ω–∏ —Ç–∞ –≥—Ä–æ–º–∞–¥—Å—å–∫–æ–≥–æ –∑–¥–æ—Ä–æ–≤''—è'),
('–ö–∏—ó–≤—Å—å–∫–∏–π –º—ñ—Å—å–∫–∏–π –º–µ–¥–∏—á–Ω–∏–π –∫–æ–ª–µ–¥–∂'),
('–•–µ—Ä—Å–æ–Ω—Å—å–∫–∏–π –¥–µ—Ä–∂–∞–≤–Ω–∏–π —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç'),
('–ú–µ–¥–∏—á–Ω–∏–π –∫–æ–ª–µ–¥–∂ ¬´–ú–æ–Ω–∞–¥–∞¬ª'),
('–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∏–π –º–µ–¥–∏—á–Ω–∏–π —Ñ–∞—Ö–æ–≤–∏–π –∫–æ–ª–µ–¥–∂'),
('–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∏–π –º–µ–¥–∏—á–Ω–∏–π —ñ–Ω—Å—Ç–∏—Ç—É—Ç'),
('–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∏–π –º–µ–¥–∏—á–Ω–∏–π –∫–æ–ª–µ–¥–∂'),
('–ö–ó–í–û ¬´–í–æ–ª–∏–Ω—Å—å–∫–∏–π –º–µ–¥–∏—á–Ω–∏–π —ñ–Ω—Å—Ç–∏—Ç—É—Ç¬ª'),
('–î–Ω—ñ–ø—Ä–æ–≤—Å—å–∫–∏–π –±–∞–∑–æ–≤–∏–π –º–µ–¥–∏—á–Ω–∏–π –∫–æ–ª–µ–¥–∂'),
('–®–µ–ø–µ—Ç—ñ–≤—Å—å–∫–∏–π –º–µ–¥–∏—á–Ω–∏–π —Ñ–∞—Ö–æ–≤–∏–π –∫–æ–ª–µ–¥–∂'),
('–•–∞—Ä–∫—ñ–≤—Å—å–∫–∏–π —ñ–Ω—Å—Ç–∏—Ç—É—Ç –º–µ–¥–∏—Ü–∏–Ω–∏ —Ç–∞ –±—ñ–æ–º–µ–¥–∏—á–Ω–∏—Ö –Ω–∞—É–∫'),
('(–ñ–ë–§–§–ö) –ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∏–π –±–∞–∑–æ–≤–∏–π —Ñ–∞—Ä–º–∞—Ü–µ–≤—Ç–∏—á–Ω–∏–π —Ñ–∞—Ö–æ–≤–∏–π –∫–æ–ª–µ–¥–∂'),
('–ö–∞–º''—è–Ω–µ—Ü—å-–ü–æ–¥—ñ–ª—å—Å—å–∫–∏–π –º–µ–¥–∏—á–Ω–∏–π —Ñ–∞—Ö–æ–≤–∏–π –∫–æ–ª–µ–¥–∂'),
('–ö–∞–º''—è–Ω—Å—å–∫–∏–π –º–µ–¥–∏—á–Ω–∏–π –∫–æ–ª–µ–¥–∂'),
('–ù–∞–≤—á–∞–ª—å–Ω–æ-–Ω–∞—É–∫–æ–≤–∏–π —ñ–Ω—Å—Ç–∏—Ç—É—Ç –º–µ–¥—Å–µ—Å—Ç—Ä–∏–Ω—Å—Ç–≤–∞');
`)

  console.log('\nüìù –í–∏–∫–æ–Ω–∞–π—Ç–µ —Ü—ñ –∫–æ–º–∞–Ω–¥–∏ –≤ Supabase SQL Editor')
}

async function main() {
  console.log('üöÄ –û—á–∏—â–µ–Ω–Ω—è —Ç–∞ –ø–µ—Ä–µ—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è Supabase...')
  
  await cleanSupabase()
  await recreateTables()
  
  console.log('\n‚úÖ –ì–æ—Ç–æ–≤–æ!')
  console.log('üìã –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏:')
  console.log('1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ Supabase Dashboard')
  console.log('2. –ü–µ—Ä–µ–π–¥—ñ—Ç—å –≤ SQL Editor')
  console.log('3. –í–∏–∫–æ–Ω–∞–π—Ç–µ SQL –∫–æ–º–∞–Ω–¥–∏ –∑–≤–µ—Ä—Ö—É')
  console.log('4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å —Å–µ—Ä–≤–µ—Ä —Ä–æ–∑—Ä–æ–±–∫–∏')
}

main().catch(console.error)
