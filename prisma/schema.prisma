// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(uuid()) @map("id") @db.Uuid
  name          String?   @map("name")
  email         String?   @unique @map("email")
  password      String?   @map("password")
  emailVerified DateTime? @map("email_verified") @db.Timestamptz()
  image         String?   @map("image")
  firstName     String?   @map("first_name")
  lastName      String?   @map("last_name")
  faculty       String?   @map("faculty")   // 'medical' | 'pharmaceutical'
  university    String?   @map("university")   // Назва університету
  yearOfStudy   Int?      @map("year_of_study")      // Рік навчання (1-6)
  phone         String?   @map("phone")   // Телефон
  dateOfBirth   DateTime? @map("date_of_birth") @db.Date   // Дата народження
  bio           String?   @map("bio")   // Біографія
  preferences   String?   @map("preferences")   // Налаштування користувача (JSON string)
  role          String    @default("student") @map("role") // 'student' | 'admin' | 'teacher'
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  accounts      Account[]
  sessions      Session[]
  subscriptions UserSubscription[]
  testAttempts  TestAttempt[]
  savedItems    SavedItem[]
  achievements  UserAchievement[]
  studySchedule StudySchedule[]
  lessonAttendance LessonAttendance[]
  randomizerAttempts RandomizerAttempt[]
  randomizerHistory RandomizerTestHistory[]
  payments      Payment[]

  @@map("users")
}

model UserSubscription {
  id                String    @id @default(cuid()) @map("id")
  userId            String    @map("user_id")
  subscriptionType  String    @map("subscription_type") // 'medical' | 'pharmaceutical' | 'premium' | 'randomizer'
  status            String    @map("status") // 'pending' | 'active' | 'expired' | 'cancelled'
  startDate         DateTime  @map("start_date") @db.Timestamptz()
  endDate           DateTime  @map("end_date") @db.Timestamptz()
  paymentProvider   String    @map("payment_provider") // 'mono'
  paymentId         String?   @map("payment_id")
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_subscriptions")
}

// Randomizer attempts (спроби Randomizer PRO)
model RandomizerAttempt {
  id                 String    @id @default(uuid()) @map("id") @db.Uuid
  userId             String    @map("user_id") @db.Uuid
  totalAttempts      Int       @default(0) @map("total_attempts")
  usedAttempts       Int       @default(0) @map("used_attempts")
  remainingAttempts  Int?      @map("remaining_attempts")
  purchaseDate       DateTime  @default(now()) @map("purchase_date") @db.Timestamptz()
  expiresAt          DateTime? @map("expires_at") @db.Timestamptz()
  paymentId          String?   @map("payment_id")
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("randomizer_attempts")
}

// Randomizer test history (історія тестів)
model RandomizerTestHistory {
  id                 String    @id @default(uuid()) @map("id") @db.Uuid
  userId             String    @map("user_id") @db.Uuid
  faculty            String    @map("faculty") // 'medical' | 'pharmaceutical'
  questionsCount     Int       @map("questions_count")
  correctAnswers     Int       @map("correct_answers")
  scorePercentage    Float     @map("score_percentage")
  timeSpentSeconds   Int?      @map("time_spent_seconds")
  completedAt        DateTime  @default(now()) @map("completed_at") @db.Timestamptz()
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("randomizer_test_history")
}

// Payments (платежі)
model Payment {
  id                 String    @id @default(uuid()) @map("id") @db.Uuid
  userId             String    @map("user_id") @db.Uuid
  invoiceId          String    @unique @map("invoice_id") // ID інвойсу від Mono
  amount             Int       @map("amount") // Сума в копійках
  status             String    @default("pending") @map("status") // 'pending' | 'success' | 'failure' | 'expired' | 'processing'
  paymentType        String    @map("payment_type") // 'randomizer'
  packageId          String    @map("package_id") // ID пакету (single, pack-5, pack-10)
  attemptsCount      Int       @map("attempts_count") // Кількість спроб
  pageUrl            String?   @map("page_url") // URL для оплати
  qrCodeData         String?   @map("qr_code_data") // QR код
  metadata           String?   @map("metadata") // Додаткові дані (JSON)
  failureReason      String?   @map("failure_reason") // Причина помилки
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz()
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([invoiceId])
  @@map("payments")
}

// Тестові спроби користувача
model TestAttempt {
  id              String    @id @default(uuid()) @map("id") @db.Uuid
  userId          String    @map("user_id")
  topicId         String?   @map("topic_id") @db.Uuid
  attemptType     String    @map("attempt_type") // тип спроби
  totalQuestions  Int       @map("total_questions")
  correctAnswers  Int       @map("correct_answers")
  score           Float     @map("score") // Результат у відсотках
  timeSpent       Int       @map("time_spent") // Час у секундах
  completedAt     DateTime? @map("completed_at") @db.Timestamptz()
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("test_attempts")
}

// Збережені елементи (тести, курси, питання)
model SavedItem {
  id          Int       @id @default(autoincrement()) @map("id")
  userId      String    @map("user_id")
  notes       String?   @map("notes")
  savedAt     DateTime? @map("saved_at") @db.Timestamp(6)
  questionType String?  @map("question_type")
  questionId  String?   @map("question_id")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_saved_questions")
}

// Досягнення користувача
model UserAchievement {
  id            String    @id @default(cuid())
  userId        String
  achievementId String    // ID досягнення
  title         String    // Назва досягнення
  description   String    // Опис досягнення
  icon          String?   // Іконка
  points        Int       // Очки за досягнення
  unlockedAt    DateTime  @default(now())
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, achievementId])
}

// Розклад навчання
model StudySchedule {
  id          String    @id @default(cuid())
  userId      String
  title       String    // Назва завдання
  description String?   // Опис
  subject     String    // Предмет
  step        String    // 'krok1' | 'krok2' | 'krok3'
  faculty     String    // 'medical' | 'pharmaceutical'
  startDate   DateTime  // Дата початку
  endDate     DateTime  // Дата завершення
  isCompleted Boolean   @default(false)
  priority    String    @default("medium") // 'low' | 'medium' | 'high'
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Уроки (планування адміном)
model Lesson {
  id              String    @id @default(cuid())
  title           String    // Назва уроку
  description     String?   // Опис уроку
  subject         String    // Предмет
  step            String    // 'krok1' | 'krok2' | 'krok3'
  faculty         String    // 'medical' | 'pharmaceutical'
  startDate       DateTime  // Дата та час початку
  endDate         DateTime  // Дата та час завершення
  location        String?   // Місце проведення
  teacherName     String?   // Ім'я викладача
  maxStudents     Int?      // Максимальна кількість студентів
  isOnline        Boolean   @default(false) // Онлайн урок чи ні
  meetingLink     String?   // Посилання на зустріч (для онлайн)
  materials       String?   // Матеріали уроку (JSON string)
  status          String    @default("scheduled") // 'scheduled' | 'ongoing' | 'completed' | 'cancelled'
  calendarEventId String?   // ID події в Google Calendar
  createdBy       String    // ID адміна, який створив урок
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  attendance      LessonAttendance[]
}

// Відвідування уроків студентами
model LessonAttendance {
  id        String    @id @default(cuid())
  userId    String
  lessonId  String
  status    String    @default("registered") // 'registered' | 'attended' | 'absent' | 'late'
  joinedAt  DateTime? // Коли приєднався до уроку
  leftAt    DateTime? // Коли покинув урок
  notes     String?   // Нотатки викладача
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson    Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  @@unique([userId, lessonId])
}
